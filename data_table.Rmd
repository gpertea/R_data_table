---
title: "Data Table basics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## What is data.table?

data.table is an R package that provides an enhanced version of the data frames.
Features of the data.table package:
* fread, fwrite: fast and feature reach delimited file reader/writer functions
* low-level parallelism: many common operations are internally parallelized to use multiple CPU threads
* fast and scalable aggregations, joins, overlapping range joins (similar to IRanges::findOverlaps), including grouping on join and update on join
* fast add/update/delete columns __by reference__ by group using no copies at all
* fast data reshaping: dcast (pivot/wider/spread) and melt (unpivot/longer/gather)



Make sure a recent version of dtplyr is also installed:
`devtools::install_github("tidyverse/dtplyr")`

```{r}
library(SummarizedExperiment)
library(data.table)
#devtools::install_github("tidyverse/dtplyr") -- if needed
library(dtplyr)
```
## fread function
Fast file reader of delimited text files, with inline column selection (not all columns are loaded).
* can take an url to fetch a remote file, instead of a local file path.
* can take a linux shell command and use its output as input, e.g.:`fread("fgrep Novel junctions.csv")`


```{r}
load("data_table/rse_jx_Roche_Habenula_qcAndAnnotated_n69.Rdata")
rse_jx_hab <- rse_jx
load("data_table/astellas_dg_hg38_rseJxn_n263.rda")
rse_jx_dg <- rse_jxn
rm(rse_jx, rse_jxn)
gc()
```

```{r}
cd_hab <- as.data.table(colData(rse_jx_hab))
cd_dg <- as.data.table(colData(rse_jx_dg))
rd_hab <- as.data.table(rowRanges(rse_jx_hab))
rd_dg <- as.data.table(rowRanges(rse_jx_dg))
head(rd_dg)
```


Differences from data frames:
* columns of type character are not converted to factors by default
* data.table does not support row names 

```{r}
head(as.data.frame(rowRanges(rse_jx_dg)))
```


## setDT() vs as.data.frame()

As opposed to `as.data.frame()`, `setDT()` attaches to a data frame by reference, 
instead of creating a copy and returning it. 


```{r}
selcols=c('seqnames', 'start', 'end', 'strand','Class', 'newGeneID', 'newGeneSymbol', 'meanExprs')
newcolnames=c('chr', 'start', 'end', 'strand','class', 'gencodeID', 'gene', 'meanExpr')
rd_dg <- rd_dg[, ..selcols]
setnames(rd_dg, selcols, newcolnames)

rd_hab <- rd_hab[, ..selcols]
setnames(rd_hab, selcols, newcolnames)

head(rd_dg)

```

## Simple subsetting of columns:
```{r}
head(rd_dg[, c("chr", "start", "end", "strand")])
# same with:
head(rd_dg[, .(chr, start, end, strand)])
#

```

## General subsetting strategy: DT[ i, j, by ]

`  DT[          i,                 j,                    by]     `
`         subset rows ,  select/calculate columns,     group by   `

```{r}
table(rd_dg$Class)
## get all junctions of Class Ingen on chr 5
r <- rd_dg[ Class=="InGen" & chr == "chr5"]
r
```

